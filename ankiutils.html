<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Anki Utils</title>
  <style>
    body {}

    table {
      border-collapse: collapse;
    }

    tr:hover {
      background: #eee;
    }

    td {
      border: 1px solid #ccc;
      padding: 1px 5px;
    }

    #actionbar {
      position: sticky;
      top: 5px;
    }

    #total {
      font-weight: bold
    }
  </style>
  <script type="module">

    const queries = {
      kanjiDecks: 'deck:KanjiNew or deck:Kanji',
      unmarkedCandidates: 'deck:jp1 and WriteFlag: and -is:suspended and -is:new and -is:learn and -tag:notwrite',
      katakana : 'deck:jp1 and WriteFlag: and -is:suspended and -is:new and -is:learn and -tag:notwrite and Kanji:',
      candidates: 'tag:writecandidate',
    };

    function doInvoke(action, version, params = {}, resolve, reject) {
      const xhr = new XMLHttpRequest();
      xhr.addEventListener('error', () => reject('failed to issue request'));
      xhr.addEventListener('load', () => {
        try {

          const response = JSON.parse(xhr.responseText);
          if (Object.getOwnPropertyNames(response).length != 2) {
            throw 'response has an unexpected number of fields';
          }
          if (!response.hasOwnProperty('error')) {
            throw 'response is missing required error field';
          }
          if (!response.hasOwnProperty('result')) {
            throw 'response is missing required result field';
          }
          if (response.error) {
            throw response.error;
          }

          resolve(response.result);
        } catch (e) {
          reject(e);
        }
      });

      xhr.open('POST', 'http://127.0.0.1:8765');
      xhr.send(JSON.stringify({ action, version, params }));
    }

    function invoke(action, version, params = {}) {
      return new Promise((resolve, reject) => {
        doInvoke(action, version, params, resolve, reject)
      });
    }

    function delayedInvoke(delay, action, version, params = {}, resolve, reject) {
      return new Promise((resolve, reject) => {
        setTimeout(() => {
          doInvoke(action, version, params, resolve, reject)
        }, delay)
      });
    }

    function isKanji(ch) {
      return (ch >= "一" && ch <= "龯") ||
        (ch >= "㐀" && ch <= "䶿");
    }

    function isKatakana(ch) {
      return ch >= "゠" && ch <= "・"
    }

    function getOnlyKanji(str) {
      const res = new Set(Array.from(str).filter(ch => isKanji(ch)))
      return res.size ? res : null;
    }

    let result;
    //result = await invoke('findNotes', 6, { "query": "deck:jp1" });
    /*
    result = await invoke('apiReflect', 6, {
      "scopes": ["actions"],
      "actions": null
    })
    */
    async function fetchTableData() {
      const knownKanjiCards = await invoke('findNotes', 6, { "query": queries.kanjiDecks });
      let knownKanji = await invoke('notesInfo', 6, { "notes": knownKanjiCards });
      knownKanji = new Set(knownKanji.map(o => o.fields.Kanji.value))
      const mainNotes = await invoke('findNotes', 6, { "query": queries.unmarkedCandidates })
      const info = await invoke('notesInfo', 6, { "notes": mainNotes });
      return info.filter(n => {
        const res = new Set(Array.from(n.fields.Kanji.value));
        if (res.size <= 1) return false;
        const onlyKanji = getOnlyKanji(res);
        if (onlyKanji == null) return false;
        if (onlyKanji.isSubsetOf(knownKanji)) return true;
        return false;
      });
    }

    async function fetchKatakana() {
      const mainNotes = await invoke('findNotes', 6, { "query": queries.katakana })
      const info = await invoke('notesInfo', 6, { "notes": mainNotes });
      return info.filter(n => {
        return Array.from(n.fields.Kana.value).filter(ch => isKatakana(ch)).length
      });
    }

    const delayBetweenRequests = 100;

    function init() {
      if (document.readyState !== 'loading') {

        document.getElementById('fetchKatakana').addEventListener('click', (e) => {
          e.preventDefault()
          fetchKatakana().then(result => {
            document.getElementById('total').innerHTML = result.length;
            makeTable(result);
          })
        })

        document.getElementById('fetch').addEventListener('click', (e) => {
          e.preventDefault()
          fetchTableData().then(result => {
            document.getElementById('total').innerHTML = result.length;
            makeTable(result);
          })
        })

        document.getElementById('settowrite').addEventListener('click', (e) => {
          e.preventDefault();
          let promises = [];
          const checked = Array.from(document.querySelectorAll('input:checked')).map(o => parseInt(o.dataset.checkNoteId));
          checked.forEach((id, index) => {
            const delay = index * delayBetweenRequests;
            promises.push(delayedInvoke(delay, 'updateNoteFields', 6, {
              "note": {
                "id": id,
                "fields": {
                  "WriteFlag": "1"
                }
              }
            }))
          });
          Promise.all(promises).then(
            invoke('removeTags', 6, {
              "notes": checked,
              "tags": "writecandidate"
            }).then(
              console.log('reload')
            )
          )
        })

        document.getElementById('addtag').addEventListener('click', (e) => {
          e.preventDefault()
          invoke('addTags', 6, {
            "notes": Array.from(document.querySelectorAll('input:checked')).map(o => parseInt(o.dataset.checkNoteId)),
            "tags": document.getElementById('action-data').value
          })
        })

        document.getElementById('removetag').addEventListener('click', (e) => {
          e.preventDefault()
          invoke('removeTags', 6, {
            "notes": Array.from(document.querySelectorAll('input:checked')).map(o => parseInt(o.dataset.checkNoteId)),
            "tags": document.getElementById('action-data').value
          })
        })

        document.getElementById('setnotwrite').addEventListener('click', (e) => {
          e.preventDefault()
          invoke('addTags', 6, {
            "notes": Array.from(document.querySelectorAll('input:checked')).map(o => parseInt(o.dataset.checkNoteId)),
            "tags": "notwrite"
          })
          invoke('removeTags', 6, {
            "notes": Array.from(document.querySelectorAll('input:checked')).map(o => parseInt(o.dataset.checkNoteId)),
            "tags": "writecandidate"
          })
        })
      }
    }

    init();

    function makeRow(noteId, kanji, kana, tags) {
      return `
        <tr data-note-id="${noteId}">
          <td data-select=""><input type="checkbox" data-check-note-id="${noteId}"></td>
          <td data-note-info="kanji">${kanji}</td>
          <td data-note-info="kana">${kana}</td>
          <td data-note-info="tags">${tags ? tags.join(', ') : ''}</td>
          <td data-note-info="noteid">${noteId}</td>
        </tr>
      `
    }

    function makeTable(data) {
      const table = document.getElementById('resTable');
      const tableEl = table.parentElement.removeChild(table);
      const rows = data.map(o => {
        return makeRow(
          o.noteId,
          o.fields['Kanji'].value,
          o.fields['Kana'].value,
          o.tags);
      });
      table.querySelector('tbody').insertAdjacentHTML('afterbegin', rows.join(''))
      document.getElementById('result').insertAdjacentElement('beforeend', table)
    }

    //console.log(result);
  </script>

</head>

<body>
  <div id="actionbar">
    <button id="fetch">fetch notes</button>
    <button id="fetchKatakana">fetch katakana notes</button>
    <br>
    <button id="addtag">add tag</button>
    <button id="removetag">remove tag</button>
    <button id="settowrite">set to write</button>
    <button id="setnotwrite">not write</button>
    <br>
    <input type="text" id="action-data">&nbsp;<span id="total"></span>
  </div>
  <div id="result">
    <table id="resTable">
      <thead>
        <tr>
          <td><input type="checkbox"></td>
          <td>Kanji</td>
          <td>Kana</td>
          <td>Tags</td>
          <td>id</td>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</body>

</html>